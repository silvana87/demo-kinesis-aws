<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Votaci√≥n en Tiempo Real üèéÔ∏è</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .dashboard-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            max-width: 800px;
            width: 100%;
        }
        h1 {
            color: #007bff;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        p.subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 30px;
        }
        .vote-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            text-align: left;
            position: relative;
        }
        .option-label {
            width: 150px;
            font-weight: bold;
            font-size: 1.1em;
            color: #444;
            flex-shrink: 0;
        }
        .progress-bar-container {
            flex-grow: 1;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 0 15px;
        }
        .progress-bar {
            height: 100%;
            background-color: #28a745;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        .vote-count {
            color: white;
            padding-right: 10px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        #loadingSpinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>üìä Resultados de Votaci√≥n en Vivo</h1>
        <p class="subtitle">¬øQu√© servicio de AWS te pareci√≥ m√°s interesante?</p>
        <div id="results-container">
            <div id="loadingSpinner"></div>
        </div>
    </div>

   <script>
        let API_GET_RESULTS_URL = '';

        // üîπ 1. Cargar configuraci√≥n desde config.json antes de iniciar la app
        async function loadConfig() {
            try {
                const response = await fetch('config.json');
                if (!response.ok) {
                    throw new Error(`No se pudo cargar config.json (status: ${response.status})`);
                }
                const config = await response.json();
                API_GET_RESULTS_URL = config.API_GET_RESULTS_URL;
                console.log('‚úÖ Configuraci√≥n cargada correctamente:', API_GET_RESULTS_URL);

                // Una vez cargada la configuraci√≥n, iniciamos la renderizaci√≥n
                fetchAndRenderResults();
                setInterval(fetchAndRenderResults, 2000);
            } catch (error) {
                console.error('‚ùå Error al cargar la configuraci√≥n:', error);
                document.getElementById('results-container').innerHTML = 
                    '<p style="color:red;">Error al cargar la configuraci√≥n. Verifica config.json.</p>';
            }
        }

        // üîπ 2. Funci√≥n para obtener y renderizar resultados
        async function fetchAndRenderResults() {
            const resultsContainer = document.getElementById('results-container');
            const loadingSpinner = document.getElementById('loadingSpinner');
            loadingSpinner.style.display = 'block';

            try {
                const response = await fetch(API_GET_RESULTS_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const results = await response.json();
                
                loadingSpinner.style.display = 'none';
                resultsContainer.innerHTML = '';

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p>Todav√≠a no hay votos. ¬°S√© el primero en votar!</p>';
                    return;
                }

                const totalVotes = results.reduce((sum, item) => sum + item.votes, 0);

                results.forEach(item => {
                    const percentage = totalVotes > 0 ? (item.votes / totalVotes) * 100 : 0;

                    const voteItemDiv = document.createElement('div');
                    voteItemDiv.className = 'vote-item';

                    const optionLabel = document.createElement('div');
                    optionLabel.className = 'option-label';
                    optionLabel.textContent = item.option_id;

                    const progressBarContainer = document.createElement('div');
                    progressBarContainer.className = 'progress-bar-container';

                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = `${percentage}%`;

                    const voteCountSpan = document.createElement('span');
                    voteCountSpan.className = 'vote-count';
                    voteCountSpan.textContent = item.votes;
                    
                    if (percentage > 5) {
                        progressBar.appendChild(voteCountSpan);
                    } else {
                        const countOutside = document.createElement('span');
                        countOutside.textContent = item.votes;
                        countOutside.style.marginLeft = '10px';
                        voteItemDiv.appendChild(countOutside);
                    }

                    progressBarContainer.appendChild(progressBar);
                    voteItemDiv.appendChild(optionLabel);
                    voteItemDiv.appendChild(progressBarContainer);
                    
                    resultsContainer.appendChild(voteItemDiv);
                });

            } catch (error) {
                console.error('Error fetching data:', error);
                loadingSpinner.style.display = 'none';
                resultsContainer.innerHTML = '<p style="color:red;">Error al cargar los resultados. Intenta de nuevo.</p>';
            }
        }

        // üîπ 3. Cargar configuraci√≥n al iniciar
        document.addEventListener('DOMContentLoaded', loadConfig);
    </script>
</body>
</html>